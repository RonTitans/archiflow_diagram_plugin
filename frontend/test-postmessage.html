<!DOCTYPE html>
<html>
<head>
    <title>Draw.io PostMessage Protocol Test</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        #editor {
            width: 100%;
            height: 600px;
            border: 2px solid #bdc3c7;
            background: white;
            border-radius: 4px;
        }
        #log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 3px;
        }
        .log-sent {
            color: #3498db;
        }
        .log-received {
            color: #27ae60;
        }
        .log-error {
            color: #e74c3c;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status.ready {
            background: #27ae60;
            color: white;
        }
        .status.waiting {
            background: #f39c12;
            color: white;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Draw.io PostMessage Protocol Test</h1>

        <div class="controls">
            <div id="status" class="status waiting">Status: Waiting for initialization...</div>

            <h3>Connection</h3>
            <button onclick="testEmbed()">Test embed.diagrams.net</button>
            <button onclick="testLocal()">Test Local Draw.io</button>

            <h3>Basic Operations</h3>
            <button onclick="sendInit()">1. Send Init</button>
            <button onclick="loadDiagram()">2. Load Diagram</button>
            <button onclick="saveDiagram()">3. Save Diagram</button>
            <button onclick="exportDiagram()">4. Export XML</button>

            <h3>Sample Diagrams</h3>
            <button onclick="loadNetworkDiagram()">Load Network Sample</button>
            <button onclick="loadBlankDiagram()">Load Blank</button>

            <h3>Custom Message</h3>
            <textarea id="customMessage" placeholder='{"action": "load", "xml": "..."}'></textarea>
            <button onclick="sendCustom()">Send Custom Message</button>
        </div>

        <iframe id="editor"></iframe>

        <div id="log"></div>
    </div>

    <script>
        let editor = null;
        let isReady = false;
        let lastXml = null;

        // Sample network diagram
        const NETWORK_DIAGRAM = `<mxfile>
            <diagram name="Network Topology">
                <mxGraphModel dx="1422" dy="754" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1">
                    <root>
                        <mxCell id="0"/>
                        <mxCell id="1" parent="0"/>
                        <mxCell id="router1" value="Core Router" style="shape=mxgraph.cisco.routers.router;html=1;" vertex="1" parent="1">
                            <mxGeometry x="350" y="200" width="78" height="53" as="geometry"/>
                        </mxCell>
                        <mxCell id="switch1" value="Switch 1" style="shape=mxgraph.cisco.switches.workgroup_switch;html=1;" vertex="1" parent="1">
                            <mxGeometry x="200" y="300" width="64" height="64" as="geometry"/>
                        </mxCell>
                        <mxCell id="switch2" value="Switch 2" style="shape=mxgraph.cisco.switches.workgroup_switch;html=1;" vertex="1" parent="1">
                            <mxGeometry x="500" y="300" width="64" height="64" as="geometry"/>
                        </mxCell>
                        <mxCell id="edge1" edge="1" parent="1" source="router1" target="switch1">
                            <mxGeometry relative="1" as="geometry"/>
                        </mxCell>
                        <mxCell id="edge2" edge="1" parent="1" source="router1" target="switch2">
                            <mxGeometry relative="1" as="geometry"/>
                        </mxCell>
                    </root>
                </mxGraphModel>
            </diagram>
        </mxfile>`;

        const BLANK_DIAGRAM = `<mxfile>
            <diagram name="Blank">
                <mxGraphModel dx="1422" dy="754" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1">
                    <root>
                        <mxCell id="0"/>
                        <mxCell id="1" parent="0"/>
                    </root>
                </mxGraphModel>
            </diagram>
        </mxfile>`;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(ready) {
            const status = document.getElementById('status');
            if (ready) {
                status.className = 'status ready';
                status.textContent = 'Status: ✅ Draw.io Ready';
                isReady = true;
            } else {
                status.className = 'status waiting';
                status.textContent = 'Status: ⏳ Waiting for initialization...';
                isReady = false;
            }
        }

        function testEmbed() {
            const iframe = document.getElementById('editor');
            const url = 'https://embed.diagrams.net/?embed=1&ui=atlas&spin=true&modified=unsavedChanges&libraries=1&noSaveBtn=1';
            iframe.src = url;
            log('Connecting to embed.diagrams.net...', 'sent');

            iframe.onload = function() {
                editor = iframe.contentWindow;
                log('iframe loaded, waiting 1 second before init...', 'received');
                setTimeout(() => sendInit(), 1000);
            };
        }

        function testLocal() {
            const iframe = document.getElementById('editor');
            const url = '/webapp/index.html?embed=1&ui=atlas&libraries=1';
            iframe.src = url;
            log('Connecting to local Draw.io...', 'sent');

            iframe.onload = function() {
                editor = iframe.contentWindow;
                log('iframe loaded, waiting 1 second before init...', 'received');
                setTimeout(() => sendInit(), 1000);
            };
        }

        function sendInit() {
            if (!editor) {
                log('Error: Editor not loaded', 'error');
                return;
            }

            const message = {
                action: 'init',
                bounds: {x: 0, y: 0, width: 10000, height: 10000}
            };

            log('Sending: ' + JSON.stringify(message), 'sent');
            editor.postMessage(JSON.stringify(message), '*');
        }

        function loadDiagram() {
            if (!isReady) {
                log('Error: Draw.io not ready', 'error');
                return;
            }

            const message = {
                action: 'load',
                autosave: 1,
                xml: lastXml || NETWORK_DIAGRAM
            };

            log('Sending load with autosave...', 'sent');
            editor.postMessage(JSON.stringify(message), '*');
        }

        function saveDiagram() {
            if (!isReady) {
                log('Error: Draw.io not ready', 'error');
                return;
            }

            const message = {
                action: 'save'
            };

            log('Sending save request...', 'sent');
            editor.postMessage(JSON.stringify(message), '*');
        }

        function exportDiagram() {
            if (!isReady) {
                log('Error: Draw.io not ready', 'error');
                return;
            }

            const message = {
                action: 'export',
                format: 'xml'
            };

            log('Sending export request...', 'sent');
            editor.postMessage(JSON.stringify(message), '*');
        }

        function loadNetworkDiagram() {
            if (!isReady) {
                log('Error: Draw.io not ready', 'error');
                return;
            }

            const message = {
                action: 'load',
                autosave: 1,
                xml: NETWORK_DIAGRAM
            };

            log('Loading network diagram sample...', 'sent');
            editor.postMessage(JSON.stringify(message), '*');
        }

        function loadBlankDiagram() {
            if (!isReady) {
                log('Error: Draw.io not ready', 'error');
                return;
            }

            const message = {
                action: 'load',
                autosave: 1,
                xml: BLANK_DIAGRAM
            };

            log('Loading blank diagram...', 'sent');
            editor.postMessage(JSON.stringify(message), '*');
        }

        function sendCustom() {
            if (!editor) {
                log('Error: Editor not loaded', 'error');
                return;
            }

            const customMessage = document.getElementById('customMessage').value;
            if (!customMessage) {
                log('Error: No custom message provided', 'error');
                return;
            }

            try {
                const parsed = JSON.parse(customMessage);
                log('Sending custom: ' + customMessage, 'sent');
                editor.postMessage(customMessage, '*');
            } catch (e) {
                log('Error: Invalid JSON - ' + e.message, 'error');
            }
        }

        // Message handler
        window.addEventListener('message', function(evt) {
            if (evt.source !== editor) return;

            try {
                const msg = JSON.parse(evt.data);
                log('Received: ' + evt.data.substring(0, 200) + (evt.data.length > 200 ? '...' : ''), 'received');

                switch(msg.event) {
                    case 'init':
                        log('✅ Draw.io initialized successfully!', 'received');
                        updateStatus(true);
                        break;

                    case 'save':
                        log('Save event received, XML length: ' + (msg.xml ? msg.xml.length : 0), 'received');
                        lastXml = msg.xml;
                        break;

                    case 'autosave':
                        log('Autosave event, XML length: ' + (msg.xml ? msg.xml.length : 0), 'received');
                        lastXml = msg.xml;
                        break;

                    case 'export':
                        log('Export received, format: ' + msg.format + ', data length: ' + (msg.data ? msg.data.length : 0), 'received');
                        if (msg.xml) lastXml = msg.xml;
                        break;

                    case 'load':
                        log('Load complete', 'received');
                        break;

                    default:
                        log('Unknown event: ' + msg.event, 'received');
                }
            } catch (e) {
                // Not a JSON message, ignore
            }
        });

        // Auto-start with embed.diagrams.net
        window.onload = function() {
            log('Page loaded, click "Test embed.diagrams.net" to begin', 'info');
        };
    </script>
</body>
</html>