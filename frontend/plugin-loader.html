<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ArchiFlow Draw.io Plugin Loader</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #drawio-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #drawio-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #loader-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }

        #loader-status.loading { display: block; background: rgba(33, 150, 243, 0.9); }
        #loader-status.success { display: block; background: rgba(76, 175, 80, 0.9); }
        #loader-status.error { display: block; background: rgba(244, 67, 54, 0.9); }
    </style>
</head>
<body>
    <div id="drawio-container">
        <div id="loader-status">Initializing Draw.io...</div>
        <iframe id="drawio-iframe"></iframe>
    </div>

    <script>
        (function() {
            // Use the proxy path to keep everything same-origin!
            const DRAWIO_URL = '/drawio';  // This proxies to localhost:8083 via simple-server.js
            const PLUGIN_PATH = '/archiflow-network-plugin.js';
            const MAX_ATTEMPTS = 30; // 15 seconds max
            const RETRY_INTERVAL = 500; // 500ms between attempts

            let attempts = 0;
            let pluginLoaded = false;
            let parentOrigin = null;

            const iframe = document.getElementById('drawio-iframe');
            const status = document.getElementById('loader-status');

            // Get parent origin for postMessage communication
            if (window.parent !== window) {
                parentOrigin = document.referrer ? new URL(document.referrer).origin : '*';
            }

            function updateStatus(message, type = 'loading') {
                status.textContent = message;
                status.className = type;

                // Hide success messages after 2 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 2000);
                }
            }

            function buildDrawioUrl() {
                const params = new URLSearchParams({
                    embed: '1',
                    ui: 'atlas',
                    spin: '1',
                    modified: 'unsavedChanges',
                    libraries: '1',
                    noSaveBtn: '1',
                    noExitBtn: '1',
                    saveAndExit: '0',
                    proto: 'json',
                    plugins: '1' // Enable plugin support
                });

                return `${DRAWIO_URL}/?${params.toString()}`;
            }

            function canAccessIframe() {
                try {
                    // Try to access the iframe window's location
                    // This will throw if cross-origin
                    const testAccess = iframe.contentWindow.location.href;
                    return true;
                } catch (e) {
                    console.log('[ArchiFlow Loader] Cross-origin detected, will use URL parameter method');
                    return false;
                }
            }

            function injectPlugin() {
                attempts++;

                if (attempts > MAX_ATTEMPTS) {
                    console.error('[ArchiFlow Loader] Max attempts reached, plugin injection failed');
                    updateStatus('Plugin loading timeout - continuing without plugin', 'error');
                    notifyParent('plugin-timeout');
                    return;
                }

                try {
                    const iframeWindow = iframe.contentWindow;
                    const iframeDoc = iframe.contentDocument || iframeWindow.document;

                    // Check if we can access the iframe
                    if (!canAccessIframe()) {
                        console.log('[ArchiFlow Loader] Cannot access iframe (cross-origin), using fallback');
                        // For cross-origin, we can't inject directly
                        // The plugin should be loaded via URL parameter as fallback
                        updateStatus('Plugin loaded via URL (cross-origin mode)', 'success');
                        notifyParent('plugin-loaded-url');
                        return;
                    }

                    // Check if Draw.io is loaded and ready
                    if (iframeWindow.Draw && iframeWindow.Draw.loadPlugin) {
                        console.log('[ArchiFlow Loader] Draw.io detected, injecting plugin...');
                        updateStatus('Injecting ArchiFlow plugin...', 'loading');

                        // Enable custom plugins
                        iframeWindow.ALLOW_CUSTOM_PLUGINS = true;

                        // Method 1: Direct script injection
                        const script = iframeDoc.createElement('script');
                        script.src = PLUGIN_PATH;
                        script.id = 'archiflow-plugin-script';

                        script.onload = function() {
                            console.log('[ArchiFlow Loader] Plugin script loaded successfully');

                            // Verify plugin is actually loaded
                            setTimeout(() => {
                                if (iframeWindow.ArchiFlow || iframeWindow.archiflowPlugin || iframeWindow.archiflowPluginLoaded) {
                                    console.log('[ArchiFlow Loader] Plugin verified and active');
                                    updateStatus('ArchiFlow plugin loaded successfully', 'success');
                                    pluginLoaded = true;
                                    notifyParent('plugin-loaded');
                                } else {
                                    console.warn('[ArchiFlow Loader] Plugin script loaded but not initialized yet, waiting...');
                                    // Give it more time before trying alternative
                                    setTimeout(() => {
                                        if (!iframeWindow.archiflowPluginLoaded && !pluginLoaded) {
                                            tryAlternativeMethod(iframeWindow);
                                        }
                                    }, 1000);
                                }
                            }, 500);
                        };

                        script.onerror = function() {
                            console.error('[ArchiFlow Loader] Failed to load plugin script, trying alternative method');
                            tryAlternativeMethod(iframeWindow);
                        };

                        // Check if script already injected
                        const existingScript = iframeDoc.getElementById('archiflow-plugin-script');
                        if (existingScript) {
                            existingScript.remove();
                        }

                        iframeDoc.head.appendChild(script);

                    } else if (iframeWindow.mxClient && iframeWindow.mxClient.VERSION) {
                        // mxGraph is loaded but Draw object might not be ready
                        console.log('[ArchiFlow Loader] mxGraph detected, waiting for Draw.io...');
                        updateStatus(`Loading Draw.io... (attempt ${attempts}/${MAX_ATTEMPTS})`, 'loading');
                        setTimeout(injectPlugin, RETRY_INTERVAL);

                    } else {
                        // Draw.io not ready yet
                        console.log(`[ArchiFlow Loader] Waiting for Draw.io... (attempt ${attempts}/${MAX_ATTEMPTS})`);
                        updateStatus(`Loading Draw.io... (attempt ${attempts}/${MAX_ATTEMPTS})`, 'loading');
                        setTimeout(injectPlugin, RETRY_INTERVAL);
                    }

                } catch (e) {
                    console.log('[ArchiFlow Loader] Error during injection attempt:', e.message);
                    if (attempts < MAX_ATTEMPTS) {
                        setTimeout(injectPlugin, RETRY_INTERVAL);
                    } else {
                        updateStatus('Plugin loading failed - continuing without plugin', 'error');
                        notifyParent('plugin-error');
                    }
                }
            }

            function tryAlternativeMethod(iframeWindow) {
                // Check if already loaded before trying alternative
                if (pluginLoaded) {
                    console.log('[ArchiFlow Loader] Plugin already loaded, skipping alternative method');
                    return;
                }

                console.log('[ArchiFlow Loader] Trying alternative injection method (fetch + eval)');
                updateStatus('Trying alternative loading method...', 'loading');

                fetch(PLUGIN_PATH)
                    .then(response => response.text())
                    .then(code => {
                        try {
                            // Wrap in IIFE to avoid polluting global scope
                            const wrappedCode = `(function() { ${code} })();`;
                            iframeWindow.eval(wrappedCode);

                            console.log('[ArchiFlow Loader] Plugin injected via eval');

                            // Verify plugin
                            setTimeout(() => {
                                if (iframeWindow.ArchiFlow || iframeWindow.archiflowPlugin) {
                                    console.log('[ArchiFlow Loader] Plugin verified after eval injection');
                                    updateStatus('ArchiFlow plugin loaded (alternative method)', 'success');
                                    pluginLoaded = true;
                                    notifyParent('plugin-loaded-eval');
                                } else {
                                    console.error('[ArchiFlow Loader] Plugin eval succeeded but object not found');
                                    updateStatus('Plugin partially loaded', 'error');
                                    notifyParent('plugin-partial');
                                }
                            }, 500);

                        } catch (evalError) {
                            console.error('[ArchiFlow Loader] Eval injection failed:', evalError);
                            updateStatus('Plugin loading failed', 'error');
                            notifyParent('plugin-error');
                        }
                    })
                    .catch(fetchError => {
                        console.error('[ArchiFlow Loader] Failed to fetch plugin:', fetchError);
                        updateStatus('Plugin loading failed', 'error');
                        notifyParent('plugin-error');
                    });
            }

            function notifyParent(status) {
                if (window.parent !== window) {
                    window.parent.postMessage({
                        source: 'archiflow-loader',
                        type: 'plugin-status',
                        status: status,
                        loaded: pluginLoaded
                    }, parentOrigin);
                }
            }

            // Forward all messages from Draw.io to parent
            window.addEventListener('message', function(evt) {
                // Forward Draw.io messages to parent
                if (evt.source === iframe.contentWindow && window.parent !== window) {
                    window.parent.postMessage(evt.data, parentOrigin);
                }
                // Forward parent messages to Draw.io
                else if (evt.source === window.parent && iframe.contentWindow) {
                    iframe.contentWindow.postMessage(evt.data, '*');
                }
            });

            // Initialize Draw.io iframe
            function initialize() {
                console.log('[ArchiFlow Loader] Initializing Draw.io iframe...');
                updateStatus('Loading Draw.io...', 'loading');

                // Build and set iframe URL
                iframe.src = buildDrawioUrl();

                // Start plugin injection after iframe loads
                iframe.onload = function() {
                    console.log('[ArchiFlow Loader] Iframe loaded, starting plugin injection in 1 second...');
                    updateStatus('Draw.io loaded, injecting plugin...', 'loading');

                    // Give Draw.io a moment to fully initialize
                    setTimeout(injectPlugin, 1000);
                };

                iframe.onerror = function(error) {
                    console.error('[ArchiFlow Loader] Iframe failed to load:', error);
                    updateStatus('Failed to load Draw.io', 'error');
                    notifyParent('iframe-error');
                };
            }

            // Start initialization
            initialize();

            // Expose loader API for parent window
            window.archiflowLoader = {
                getStatus: () => pluginLoaded,
                reinject: injectPlugin,
                reload: () => {
                    attempts = 0;
                    pluginLoaded = false;
                    iframe.src = buildDrawioUrl();
                }
            };

        })();
    </script>
</body>
</html>